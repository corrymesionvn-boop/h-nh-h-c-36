<!DOCTYPE html>
<html>
<head>
    <title>GD Rau Ma PS4</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { display: block; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); color: white; text-align: center; padding: 50px;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <h1 id="title" style="font-size: 60px; color: #2ecc71;">GEOMETRY RAU MÁ</h1>
        <p id="cache-status">Đang tải...</p>
        <button style="padding: 20px 50px; font-size: 25px;" onclick="startGame()">NHẤN (X) ĐỂ CHƠI</button>
        <p style="margin-top: 20px; color: #f1c40f;">Music: Creo, Dimrain47, Tommi Uimonen</p>
    </div>
    <canvas id="g"></canvas>

    <script>
        // 1. Đăng ký Service Worker (Để chơi Offline)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => {
                document.getElementById('cache-status').innerText = "✅ ĐÃ LƯU OFFLINE";
            });
        }

        const c = document.getElementById('g');
        const ctx = c.getContext('2d');
        const songFiles = ["music1.mp3", "music2.mp3", "music3.mp3", "music4.mp3", "music5.mp3"];
        const bgm = new Audio();
        let state = 'start', isPress = false, lastXState = false;
        let score = 0, rauMa = 0, frame = 0;
        const p = { x: 200, y: 0, w: 45, h: 45, dy: 0, gnd: false };

        // 2. Hàm quét tay cầm PS4
        function updateGamepad() {
            const gps = navigator.getGamepads();
            if (!gps[0]) return;
            const gp = gps[0];
            const xPressed = gp.buttons[0].pressed; // Nút X

            if (xPressed) {
                if (state === 'playing') isPress = true;
                else if (!lastXState) startGame();
            } else {
                isPress = false;
            }
            lastXState = xPressed;
        }

        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            if (state !== 'playing') {
                score = 0; rauMa = 0; p.y = 300;
                bgm.src = "music/" + songFiles[Math.floor(Math.random()*5)];
                bgm.play();
            }
            state = 'playing';
            loop();
        }

        function loop() {
            if (state !== 'playing') return;
            updateGamepad();
            frame++; score++;
            ctx.fillStyle = "#050505"; ctx.fillRect(0,0,c.width,c.height);

            // Vật lý nhảy
            p.dy += 1.3; 
            if(isPress && p.gnd) p.dy = -16;
            p.y += p.dy;

            const floor = c.height - 150;
            if(p.y > floor - p.h) { p.y = floor - p.h; p.dy = 0; p.gnd = true; }
            else p.gnd = false;

            // Vẽ sàn & Nhân vật
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(0, floor, c.width, 10);
            ctx.fillStyle = "#0f0"; ctx.fillRect(p.x, p.y, p.w, p.h);
            
            // UI
            ctx.fillStyle = "#fff"; ctx.font = "30px Arial";
            ctx.fillText("Score: " + Math.floor(score/10), 50, 50);

            requestAnimationFrame(loop);
        }

        // Kiểm tra tay cầm liên tục ngay cả khi chưa vào game
        setInterval(() => { if(state !== 'playing') updateGamepad(); }, 50);
        window.onresize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize();
    </script>
</body>
</html>
