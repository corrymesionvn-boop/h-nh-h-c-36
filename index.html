<!DOCTYPE html>
<html>
<head>
    <title>Geometry Rau Má - Universal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); color: white; z-index: 100; text-align: center;
            padding: 40px; box-sizing: border-box;
        }
        .btn {
            padding: 20px 50px; font-size: 28px; cursor: pointer; border: 4px solid #fff;
            border-radius: 50px; background: #2ecc71; color: white; font-weight: bold;
        }
        #cache-info { font-size: 14px; color: #f1c40f; margin-bottom: 15px; }
        .credits { font-size: 16px; color: #888; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1 id="title" style="font-size: 60px; color: #2ecc71; margin: 0;">GEOMETRY RAU MÁ</h1>
        <div id="cache-info">Đang kiểm tra dữ liệu Offline...</div>
        <button class="btn" id="btn-main" onclick="startGame()">BẮT ĐẦU</button>
        <div class="credits">Music: Creo, Dimrain47, Tommi Uimonen</div>
        <div id="device-info" style="font-size: 12px; margin-top: 10px; color: #555;"></div>
    </div>
    <canvas id="g"></canvas>

    <script>
        // --- 1. ĐĂNG KÝ SERVICE WORKER (OFFLINE MODE) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => {
                document.getElementById('cache-info').innerText = "✅ ĐÃ LƯU OFFLINE (SẴN SÀNG CHO PS4)";
            }).catch(() => {
                document.getElementById('cache-info').innerText = "⚠️ Chế độ Offline lỗi";
            });
        }

        const c = document.getElementById('g');
        const ctx = c.getContext('2d');
        const songFiles = ["music/music1.mp3", "music/music2.mp3", "music/music3.mp3", "music/music4.mp3", "music/music5.mp3"];
        const bgm = new Audio();
        let state = 'start', score = 0, rauMa = 0, frame = 0, isPress = false;
        const p = { x: 200, y: 0, w: 45, h: 45, dy: 0, gnd: false, rot: 0 };

        // --- 2. ĐIỀU KHIỂN ĐA NỀN TẢNG ---
        
        // PC & PS4 (Bàn phím + Nút ảo)
        window.onkeydown = (e) => { if(e.code==='Space') handleInputStart(); };
        window.onkeyup = (e) => { if(e.code==='Space') handleInputEnd(); };

        // Mobile
        window.ontouchstart = (e) => { e.preventDefault(); handleInputStart(); };
        window.ontouchend = () => handleInputEnd();

        // Gamepad (PS4)
        let lastX = false;
        function pollGamepad() {
            const gps = navigator.getGamepads();
            if (gps[0]) {
                const x = gps[0].buttons[0].pressed;
                if (x) handleInputStart();
                else if (lastX) handleInputEnd();
                lastX = x;
            }
        }

        function handleInputStart() {
            if (state === 'playing') isPress = true;
            else if (state !== 'playing') startGame();
        }
        function handleInputEnd() { isPress = false; }

        // --- 3. VÒNG LẶP GAME ---

        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            if (state !== 'playing') {
                score = 0; rauMa = 0; p.y = c.height/2;
                bgm.src = songFiles[Math.floor(Math.random()*5)];
                bgm.play().catch(()=>{});
            }
            state = 'playing';
            loop();
        }

        function loop() {
            if (state !== 'playing') return;
            pollGamepad();
            frame++; score++;
            
            ctx.fillStyle = "#080808"; ctx.fillRect(0,0,c.width,c.height);

            // Vật lý đơn giản
            p.dy += 1.3; if(isPress && p.gnd) p.dy = -16;
            p.y += p.dy;
            const floor = c.height - 150;
            if(p.y > floor - p.h) { p.y = floor - p.h; p.dy = 0; p.gnd = true; p.rot = 0; }
            else { p.gnd = false; p.rot += 5; }

            // Vẽ sàn & Player
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(0, floor, c.width, 10);
            ctx.save();
            ctx.translate(p.x + p.w/2, p.y + p.h/2);
            ctx.rotate(p.rot * Math.PI / 180);
            ctx.fillStyle = "#0f0"; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.strokeRect(-p.w/2, -p.h/2, p.w, p.h);
            ctx.restore();

            // Score UI
            ctx.fillStyle = "white"; ctx.font = "bold 30px Arial";
            ctx.fillText(Math.floor(score/10) + "m", c.width - 120, 70);

            requestAnimationFrame(loop);
        }

        window.onresize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize();
        setInterval(() => { if(state !== 'playing') pollGamepad(); }, 50);
    </script>
</body>
</html>
