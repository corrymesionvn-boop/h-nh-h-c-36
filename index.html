<!DOCTYPE html>
<html>
<head>
    <title>Geometry Rau Má - Ultimate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.85); color: white; z-index: 100; text-align: center; padding: 40px; box-sizing: border-box;
        }
        .btn-group { display: flex; gap: 20px; margin-top: 20px; }
        .btn { padding: 18px 45px; font-size: 24px; cursor: pointer; border: 3px solid #fff; border-radius: 50px; background: #2ecc71; color: white; font-weight: bold; transition: 0.2s; }
        .btn.reset { background: #e67e22; }
        #status { font-size: 14px; color: #f1c40f; margin-bottom: 10px; }
        .info { font-size: 18px; margin: 10px; color: #3498db; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1 id="title" style="font-size: clamp(40px, 10vw, 70px); color: #2ecc71; margin: 0; text-shadow: 0 0 20px #2ecc71;">GEOMETRY RAU MÁ</h1>
        <div id="status">Đang nạp dữ liệu...</div>
        <div id="record" class="info"></div>
        <div class="btn-group">
            <button class="btn" id="btn-main" onclick="startGame()">BẮT ĐẦU</button>
            <button class="btn reset" id="btn-reset" style="display:none" onclick="fullReset()">CHƠI LẠI</button>
        </div>
        <div class="info" style="color:#888; font-size: 14px;">X (PS4) | Touch (Mobile) | Space (PC)<br>Options/P: Tạm dừng</div>
    </div>
    <canvas id="g"></canvas>

    <script>
        // --- OFFLINE CACHE ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => {
                document.getElementById('status').innerText = "✅ ĐÃ LƯU OFFLINE";
            });
        }

        const c = document.getElementById('g');
        const ctx = c.getContext('2d');
        const songFiles = ["music/music1.mp3", "music/music2.mp3", "music/music3.mp3", "music/music4.mp3", "music/music5.mp3"];
        const bgm = new Audio();
        
        let state = 'start', score = 0, rauMa = 0, frame = 0, speed = 8.5;
        let mode = 'cube', isPress = false, lastX = false, lastOpt = false;
        let hiScore = localStorage.getItem('gdHiScore') || 0;
        let hiRauMa = localStorage.getItem('gdHiRauMa') || 0;
        
        let obs = [], blks = [], items = [], ports = [];
        const p = { x: 200, y: 0, w: 42, h: 42, dy: 0, gnd: false, rot: 0 };

        // --- ĐIỀU KHIỂN ---
        const jumpStart = () => { if(state === 'playing') isPress = true; else if(state !== 'paused') startGame(); else resumeGame(); };
        const jumpEnd = () => isPress = false;

        window.onkeydown = (e) => { 
            if(e.code === 'Space') jumpStart(); 
            if(e.code === 'KeyP') togglePause();
        };
        window.onkeyup = (e) => { if(e.code === 'Space') jumpEnd(); };
        window.ontouchstart = (e) => { e.preventDefault(); jumpStart(); };
        window.ontouchend = () => jumpEnd();

        function checkGamepad() {
            const gps = navigator.getGamepads();
            if (gps[0]) {
                const x = gps[0].buttons[0].pressed;
                const opt = gps[0].buttons[9].pressed;
                if (x && !lastX) jumpStart(); else if (!x && lastX) jumpEnd();
                if (opt && !lastOpt) togglePause();
                lastX = x; lastOpt = opt;
            }
        }

        function togglePause() {
            if (state === 'playing') {
                state = 'paused';
                document.getElementById('overlay').style.display = 'flex';
                document.getElementById('title').innerText = "TẠM DỪNG";
                document.getElementById('btn-main').innerText = "TIẾP TỤC";
                document.getElementById('btn-reset').style.display = 'block';
                bgm.volume = 0.2;
            } else if (state === 'paused') resumeGame();
        }

        function resumeGame() {
            state = 'playing';
            document.getElementById('overlay').style.display = 'none';
            bgm.volume = 1;
            loop();
        }

        function fullReset() {
            state = 'start';
            startGame();
        }

        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('btn-reset').style.display = 'none';
            if (state !== 'paused') {
                score = 0; rauMa = 0; frame = 0; mode = 'cube'; speed = 8.5;
                obs = []; blks = []; items = []; ports = [];
                p.y = c.height/2; p.dy = 0;
                bgm.src = songFiles[Math.floor(Math.random()*5)];
                bgm.play().catch(()=>{});
            }
            state = 'playing';
            bgm.volume = 1;
            loop();
        }

        function spawn() {
            const floor = c.height - 100;
            if (frame % 90 === 0) {
                if (mode === 'cube') {
                    if (Math.random() < 0.6) obs.push({x: c.width, y: floor - 45, w: 40, h: 45, t: 'bot'});
                    else blks.push({x: c.width, y: floor - 130, w: 160, h: 35});
                } else {
                    let gap = 180;
                    let htop = Math.random() * (floor - 300) + 50;
                    obs.push({x: c.width, y: 0, w: 50, h: htop, t: 'top'});
                    obs.push({x: c.width, y: htop + gap, w: 50, h: floor - (htop + gap), t: 'bot'});
                }
            }
            if (frame % 70 === 0) items.push({x: c.width, y: Math.random() * (floor - 150) + 100});
            if (frame % 500 === 0) {
                const next = (mode === 'cube') ? (Math.random() > 0.5 ? 'ship' : 'wave') : 'cube';
                ports.push({x: c.width, y: 50, w: 70, h: floor-50, to: next});
            }
        }

        function die() {
            state = 'dead';
            if (score > hiScore) { hiScore = score; localStorage.setItem('gdHiScore', hiScore); }
            if (rauMa > hiRauMa) { hiRauMa = rauMa; localStorage.setItem('gdHiRauMa', hiRauMa); }
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('title').innerText = "THẤT BẠI";
            document.getElementById('btn-main').innerText = "THỬ LẠI";
            document.getElementById('record').innerHTML = `KỶ LỤC: ${Math.floor(hiScore/10)}m | RAU MÁ: ${hiRauMa}`;
            bgm.pause();
        }

        function loop() {
            if (state !== 'playing') return;
            checkGamepad();
            frame++; score++;
            if (score % 500 === 0) speed += 0.2;
            spawn();

            ctx.fillStyle = "#080808"; ctx.fillRect(0,0,c.width,c.height);
            const floor = c.height - 100;

            // Vật lý
            if (mode === 'ship') { p.dy += (isPress ? -0.8 : 0.7); p.dy *= 0.98; p.rot = p.dy * 2; }
            else if (mode === 'wave') { p.dy = isPress ? -9 : 9; p.rot = isPress ? -45 : 45; }
            else { p.dy += 1.35; if(isPress && p.gnd) p.dy = -17; p.rot = p.gnd ? 0 : p.rot + 5; }
            
            p.y += p.dy;
            if(p.y > floor - p.h) { p.y = floor - p.h; p.dy = 0; p.gnd = true; } 
            else if(p.y < 50) { p.y = 50; p.dy = 0; } else p.gnd = false;

            // Vẽ sàn & Cổng & Vật phẩm
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(0, floor, c.width, 10);
            
            items.forEach((m, i) => {
                m.x -= speed;
                ctx.fillStyle = "#2ecc71"; ctx.beginPath(); ctx.arc(m.x, m.y, 12, 0, 7); ctx.fill();
                if(p.x < m.x+12 && p.x+p.w > m.x-12 && p.y < m.y+12 && p.y+p.h > m.y-12) { items.splice(i, 1); rauMa++; }
            });

            obs.forEach((o, i) => {
                o.x -= speed;
                ctx.fillStyle = "#ff4757"; ctx.beginPath();
                if(o.t === 'top') { ctx.moveTo(o.x, 0); ctx.lineTo(o.x+o.w, 0); ctx.lineTo(o.x+o.w/2, o.h); }
                else { ctx.moveTo(o.x, floor); ctx.lineTo(o.x+o.w, floor); ctx.lineTo(o.x+o.w/2, floor-o.h); }
                ctx.fill();
                if(p.x+5 < o.x+o.w && p.x+p.w-5 > o.x && ((o.t==='bot' && p.y+p.h > floor-o.h+5) || (o.t==='top' && p.y < o.h-5))) die();
            });

            blks.forEach((b, i) => {
                b.x -= speed;
                ctx.fillStyle = "#333"; ctx.fillRect(b.x, b.y, b.w, b.h);
                if(p.x < b.x+b.w && p.x+p.w > b.x && p.y+p.h > b.y && p.y < b.y+b.h) {
                    if(p.dy > 0 && p.y+p.h < b.y+25) { p.y = b.y-p.h; p.dy = 0; p.gnd = true; } else die();
                }
            });

            ports.forEach((o, i) => {
                o.x -= speed; ctx.fillStyle = o.to === 'ship' ? "#ff0" : o.to === 'wave' ? "#0ff" : "#0f0";
                ctx.globalAlpha = 0.3; ctx.fillRect(o.x, o.y, o.w, o.h); ctx.globalAlpha = 1;
                if(p.x > o.x && p.x < o.x+o.w) mode = o.to;
            });

            // Player
            ctx.save(); ctx.translate(p.x+p.w/2, p.y+p.h/2); ctx.rotate(p.rot*Math.PI/180);
            ctx.fillStyle = (mode==='ship'?'#ff0':mode==='wave'?'#0ff':'#0f0');
            ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.strokeStyle="#fff"; ctx.lineWidth=3; ctx.strokeRect(-p.w/2,-p.h/2,p.w,p.h);
            ctx.restore();

            // UI
            ctx.fillStyle = "white"; ctx.font = "bold 25px Arial";
            ctx.fillText(`RAU MÁ: ${rauMa} | ${Math.floor(score/10)}m`, 50, 60);

            requestAnimationFrame(loop);
        }

        document.getElementById('record').innerHTML = `KỶ LỤC: ${Math.floor(hiScore/10)}m | RAU MÁ: ${hiRauMa}`;
        window.onresize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize();
    </script>
</body>
</html>
