<!DOCTYPE html>
<html>
<head>
    <title>Geometry Rau M√° - Ultimate Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.85); color: white; z-index: 100; text-align: center;
        }
        .btn-group { display: flex; gap: 20px; margin-top: 20px; }
        .btn {
            padding: 15px 35px; font-size: 20px; cursor: pointer; border: none;
            border-radius: 50px; background: #2ecc71; color: white;
            font-weight: bold; transition: 0.3s; box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        .btn.reset { background: #e67e22; }
        .record-box { margin: 20px 0; padding: 15px; border: 2px dashed #444; border-radius: 15px; background: rgba(255,255,255,0.05); }
        .credits { font-size: 14px; color: #f1c40f; margin-top: 20px; line-height: 1.6; }
        #game-ui {
            position: fixed; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: center;
            color: white; font-size: 24px; font-weight: bold; z-index: 50; pointer-events: none;
        }
        #mobile-pause {
            position: fixed; top: 20px; right: 20px; width: 50px; height: 50px;
            background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px;
            color: white; font-size: 24px; display: none; align-items: center; justify-content: center;
            z-index: 60; cursor: pointer; pointer-events: auto;
        }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="game-ui" style="display:none">
        <div id="ui-rm">Rau M√°: 0</div>
        <div id="ui-sc">0m</div>
    </div>

    <div id="mobile-pause" onclick="togglePause()">||</div>

    <div id="overlay">
        <h1 id="title" style="font-size: 50px; margin: 0; color: #2ecc71; text-shadow: 0 0 15px #2ecc71;">GEOMETRY RAU M√Å</h1>
        
        <div class="record-box">
            <div style="color: #f1c40f; font-size: 16px; letter-spacing: 2px;">üèÜ K·ª∂ L·ª§C C·ª¶A B·∫†N üèÜ</div>
            <div id="hi-display" style="font-size: 26px; margin-top: 5px;">0m | 0 Rau M√°</div>
        </div>

        <div class="btn-group">
            <button class="btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U CH∆†I</button>
            <button class="btn reset" id="reset-btn" style="display:none" onclick="resetGameFull()">CH∆†I L·∫†I</button>
        </div>

        <div class="credits">
            Music: <b>Creo, Dimrain47, Tommi Uimonen</b><br>
            <span style="color: #666; font-size: 12px;">PS4: X (Nh·∫£y), ‚ñ≥ (D·ª´ng) | Chu·ªôt: Tr√°i (Nh·∫£y), Ph·∫£i (D·ª´ng)<br>PC: Space/‚Üë | Mobile: Ch·∫°m</span>
        </div>
    </div>

    <canvas id="g"></canvas>

    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

        const c = document.getElementById('g'), ctx = c.getContext('2d');
        const overlay = document.getElementById('overlay'), gameUI = document.getElementById('game-ui'), mobilePause = document.getElementById('mobile-pause');
        const bgm = new Audio();
        const songFiles = ["music1.mp3", "music2.mp3", "music3.mp3", "music4.mp3", "music5.mp3"];
        
        let state = 'start', score = 0, rauMa = 0, frame = 0, speed = 8.5, mode = 'cube', bgH = 250;
        let hiScore = localStorage.getItem('gdHiScore') || 0;
        let hiRauMa = localStorage.getItem('gdHiRauMa') || 0;
        const p = { x: 200, y: 0, w: 38, h: 38, dy: 0, rot: 0, gnd: false };
        let obs = [], blks = [], items = [], ports = [];
        let isPress = false, lastX = false, lastTri = false;

        const resize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize = resize; resize();

        function startGame() {
            overlay.style.display = 'none'; gameUI.style.display = 'flex'; mobilePause.style.display = 'flex';
            if (state !== 'paused') {
                score = 0; rauMa = 0; frame = 0; mode = 'cube'; speed = 9;
                obs = []; blks = []; items = []; ports = [];
                p.y = c.height / 2; p.dy = 0;
                bgm.src = "music/" + songFiles[Math.floor(Math.random()*songFiles.length)];
                bgm.loop = true; bgm.play().catch(()=>{});
            }
            state = 'playing'; bgm.volume = 1; anim();
        }

        function togglePause() {
            if (state === 'playing') {
                state = 'paused'; overlay.style.display = 'flex'; gameUI.style.display = 'none'; mobilePause.style.display = 'none';
                document.getElementById('title').innerText = "T·∫†M D·ª™NG";
                document.getElementById('reset-btn').style.display = 'block';
                bgm.volume = 0.2;
            } else if (state === 'paused') startGame();
        }

        function die() {
            state = 'dead'; gameUI.style.display = 'none'; mobilePause.style.display = 'none';
            if (score > hiScore) { hiScore = score; localStorage.setItem('gdHiScore', hiScore); }
            if (rauMa > hiRauMa) { hiRauMa = rauMa; localStorage.setItem('gdHiRauMa', hiRauMa); }
            overlay.style.display = 'flex'; document.getElementById('title').innerText = "B·∫†N ƒê√É CH·∫æT";
            document.getElementById('reset-btn').style.display = 'none'; bgm.pause(); updateUI();
        }

        function updateUI() { document.getElementById('hi-display').innerText = `${Math.floor(hiScore/10)}m | ${hiRauMa} Rau M√°`; }
        updateUI();

        // --- ƒêI·ªÄU KHI·ªÇN CHU·ªòT ---
        window.onmousedown = (e) => {
            if (e.button === 0) { // Chu·ªôt tr√°i
                if(state==='playing') isPress = true; else if(overlay.style.display === 'none') startGame();
            }
            if (e.button === 2) togglePause(); // Chu·ªôt ph·∫£i
        };
        window.onmouseup = (e) => { if(e.button === 0) isPress = false; };

        // --- ƒêI·ªÄU KHI·ªÇN PH√çM/TOUCH/GAMEPAD ---
        window.onkeydown = (e) => { 
            if(e.code==='Space' || e.code==='ArrowUp') { if(state==='playing') isPress=true; else startGame(); }
            if(e.code==='KeyP') togglePause();
        };
        window.onkeyup = (e) => { if(e.code==='Space' || e.code==='ArrowUp') isPress=false; };
        window.ontouchstart = (e) => { if(e.target.id === 'mobile-pause') return; e.preventDefault(); if(state==='playing') isPress=true; else startGame(); };
        window.ontouchend = () => isPress = false;

        function checkGamepad() {
            const gps = navigator.getGamepads();
            if (gps[0]) {
                const x = gps[0].buttons[0].pressed, triangle = gps[0].buttons[3].pressed;
                if (x) { if(state==='playing') isPress=true; else if(!lastX) startGame(); } else isPress = false;
                if (triangle && !lastTri) togglePause();
                lastX = x; lastTri = triangle;
            }
        }

        function spawn() {
            if (state !== 'playing') return;
            const floor = c.height - 100, isHard = score > 2000;
            if (frame % 80 === 0 && mode === 'cube') {
                if (Math.random() < 0.75) {
                    let count = isHard ? (Math.random() > 0.5 ? 3 : 2) : 1;
                    for(let i=0; i<count; i++) obs.push({x: c.width + (i*34), y: floor - 44, w: 32, h: 44, t: 'bot'});
                } else blks.push({x: c.width, y: floor - 140, w: 180, h: 32});
            }
            if (frame % 60 === 0) items.push({x: c.width, y: mode==='cube'?floor-75:150+Math.random()*(c.height-300)});
            if ((mode === 'ship' || mode === 'wave') && frame % 22 === 0) {
                let gap = isHard ? 160 : 210;
                let mv = Math.sin(frame/20)*(c.height/5);
                obs.push({x: c.width, y: 50, w: 60, h: (c.height/2-gap)+mv, t: 'top'});
                obs.push({x: c.width, y: floor - ((c.height/2-gap)-mv), w: 60, h: (c.height/2-gap)-mv, t: 'bot'});
            }
            if (frame % 450 === 0) {
                const list = ['cube', 'ship', 'wave'].filter(m => m !== mode);
                ports.push({x: c.width, y: 50, w: 70, h: floor-50, to: list[Math.floor(Math.random()*list.length)]});
            }
        }

        function anim() {
            if (state !== 'playing') return;
            checkGamepad(); frame++; score++;
            if (score > 2000 && frame % 1000 === 0) speed += 0.2;
            const floor = c.height - 100, ceil = 50;
            bgH = (bgH + 0.2) % 360;
            ctx.fillStyle = `hsla(${bgH}, 30%, 5%, 1)`; ctx.fillRect(0,0,c.width,c.height);

            if (mode === 'ship') { p.dy += (isPress ? -0.88 : 0.78); p.dy *= 0.98; p.rot = p.dy*2.5; }
            else if (mode === 'wave') { p.dy = isPress ? -10 : 10; p.rot = isPress ? -45 : 45; }
            else { p.dy += 1.45; if(isPress && p.gnd) p.dy = -17; p.rot = p.gnd ? Math.round(p.rot/90)*90 : p.rot+7; }

            p.y += p.dy;
            if(p.y > floor-p.h){ p.y = floor-p.h; p.dy = 0; p.gnd = true; }
            else if(p.y < ceil){ p.y = ceil; p.dy = 0; } else p.gnd = false;

            ctx.fillStyle = `hsl(${bgH}, 100%, 50%)`;
            ctx.fillRect(0, floor, c.width, 10); ctx.fillRect(0, ceil-10, c.width, 10);

            obs.forEach((o, i) => { 
                o.x -= speed; ctx.fillStyle='#f44'; ctx.beginPath();
                if(o.t==='top'){ctx.moveTo(o.x,50);ctx.lineTo(o.x+o.w,50);ctx.lineTo(o.x+o.w/2,50+o.h);}
                else{ctx.moveTo(o.x,floor);ctx.lineTo(o.x+o.w,floor);ctx.lineTo(o.x+o.w/2,floor-o.h);}
                ctx.fill();
                if(p.x+8 < o.x+o.w && p.x+p.w-8 > o.x && p.y+8 < o.y+o.h && p.y+p.h-8 > o.y) die();
                if(o.x < -100) obs.splice(i, 1);
            });

            blks.forEach((b, i) => { 
                b.x -= speed; ctx.fillStyle='#333'; ctx.fillRect(b.x,b.y,b.w,b.h); 
                if(p.x < b.x+b.w && p.x+p.w > b.x && p.y+p.h > b.y && p.y < b.y+b.h) {
                    if(p.dy > 0 && p.y+p.h < b.y+25){ p.y=b.y-p.h; p.dy=0; p.gnd=true; } else die();
                }
                if(b.x < -200) blks.splice(i, 1);
            });

            ports.forEach((o, i) => { 
                o.x -= speed; ctx.fillStyle=o.to==='wave'?'#0ff':o.to==='ship'?'#ff0':'#0f0';
                ctx.globalAlpha=0.3; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.globalAlpha=1;
                if(p.x+p.w > o.x && p.x < o.x+o.w) { if(mode !== o.to) { mode = o.to; obs = []; blks = []; } }
                if(o.x < -100) ports.splice(i, 1);
            });

            items.forEach((m, i) => { 
                m.x -= speed; ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(m.x,m.y,12,0,7); ctx.fill();
                if(Math.hypot(p.x+19-m.x, p.y+19-m.y) < 36){ items.splice(i,1); rauMa++; }
                if(m.x < -100) items.splice(i, 1);
            });

            ctx.save(); ctx.translate(p.x+p.w/2, p.y+p.h/2); ctx.rotate(p.rot*Math.PI/180);
            let pC = mode==='ship'?'#ff0':mode==='wave'?'#0ff':'#0f0';
            ctx.fillStyle=pC; ctx.shadowBlur=15; ctx.shadowColor=pC;
            ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.strokeRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();

            document.getElementById('ui-rm').innerText = `Rau M√°: ${rauMa}`;
            document.getElementById('ui-sc').innerText = `${Math.floor(score/10)}m`;
            requestAnimationFrame(anim);
        }
        setInterval(spawn, 50);
        function resetGameFull() { state = 'start'; startGame(); }
    </script>
</body>
</html>
