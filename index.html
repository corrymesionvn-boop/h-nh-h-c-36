<!DOCTYPE html>
<html>
<head>
    <title>H√¨nh H·ªçc 36 - Final Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.85); color: white; z-index: 100; text-align: center;
        }
        #mobile-pause {
            position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px;
            background: rgba(255,255,255,0.2); border: 3px solid #fff; border-radius: 50%;
            color: white; font-size: 30px; display: none; align-items: center; justify-content: center;
            z-index: 200; font-weight: bold;
        }
        .btn { padding: 15px 40px; font-size: 22px; cursor: pointer; border: none; border-radius: 50px; background: #2ecc71; color: white; font-weight: bold; margin: 10px; }
        #mute-btn { background: #e67e22; font-size: 16px; display: none; }
        #game-ui { position: fixed; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; color: white; font-size: 24px; font-weight: bold; z-index: 50; text-shadow: 2px 2px #000; pointer-events: none; }
        .leaderboard { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 15px 0; border: 1px dashed #444; width: 250px; }
        .joke-warn { font-size: 12px; color: #f1c40f; margin-bottom: 10px; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="game-ui" style="display:none">
        <div id="ui-rm">Rau M√°: 0</div>
        <div id="ui-sc">0m</div>
    </div>

    <div id="mobile-pause">||</div>

    <div id="overlay">
        <h1 id="title" style="color: #2ecc71; font-size: 40px; margin: 0;">H√åNH H·ªåC 36</h1>
        <div class="joke-warn">L∆∞u √Ω: Game n√†y do AI l√†m ra v·ªõi m·ª•c ƒë√≠ch joke, kh√¥ng c√≥ √Ω x√∫c ph·∫°m t·ªõi t·ªï ch·ª©c hay c√° nh√¢n n√†o c·∫£!</div>
        
        <div class="leaderboard">
            <div style="color: #f1c40f; font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 10px;">üèÜ B·∫¢NG V√ÄNG</div>
            <div id="top1">#1: 0m</div>
            <div id="top2">#2: 0m</div>
            <div id="top3">#3: 0m</div>
        </div>

        <button class="btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
        <button id="mute-btn" class="btn" onclick="toggleMute()">NH·∫†C: B·∫¨T</button>
    </div>

    <canvas id="g"></canvas>

    <script>
        const c = document.getElementById('g'), ctx = c.getContext('2d');
        const overlay = document.getElementById('overlay'), mobilePause = document.getElementById('mobile-pause'), muteBtn = document.getElementById('mute-btn');
        const bgm = new Audio();
        const songFiles = ["music1.mp3", "music2.mp3", "music3.mp3", "music4.mp3", "music5.mp3"];
        
        const raumaImg = new Image(); raumaImg.src = 'rauma.png';
        let hasImg = false; raumaImg.onload = () => hasImg = true;

        let state = 'start', score = 0, rauMa = 0, speed = 10, mode = 'cube', frame = 0, isMuted = false;
        let trails = [];
        let leaders = JSON.parse(localStorage.getItem('gdTopScores')) || [0, 0, 0];
        const p = { x: 180, y: 0, w: 34, h: 34, dy: 0, rot: 0, gnd: false }; // Thu nh·ªè size hi·ªÉn th·ªã m·ªôt ch√∫t
        let obs = [], items = [], ports = [];
        let isPress = false, lastX = false, lastTri = false;

        const resize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize = resize; resize();

        function updateLeaderboardUI() {
            document.getElementById('top1').innerText = `#1: ${Math.floor(leaders[0]/10)}m`;
            document.getElementById('top2').innerText = `#2: ${Math.floor(leaders[1]/10)}m`;
            document.getElementById('top3').innerText = `#3: ${Math.floor(leaders[2]/10)}m`;
        }
        updateLeaderboardUI();

        function saveScore(newScore) {
            leaders.push(newScore); leaders.sort((a, b) => b - a);
            leaders = leaders.slice(0, 3);
            localStorage.setItem('gdTopScores', JSON.stringify(leaders));
            updateLeaderboardUI();
        }

        function toggleMute() { isMuted = !isMuted; bgm.muted = isMuted; muteBtn.innerText = isMuted ? "NH·∫†C: T·∫ÆT" : "NH·∫†C: B·∫¨T"; }

        function togglePause(e) {
            if(e) { e.stopPropagation(); e.preventDefault(); }
            if (state === 'playing') {
                state = 'paused'; overlay.style.display = 'flex'; mobilePause.style.display = 'none';
                muteBtn.style.display = 'inline-block'; document.getElementById('title').innerText = "T·∫†M D·ª™NG";
                bgm.volume = 0.2;
            } else if (state === 'paused') startGame();
        }

        mobilePause.addEventListener('touchstart', togglePause);
        mobilePause.addEventListener('mousedown', togglePause);

        function startGame() {
            overlay.style.display = 'none'; document.getElementById('game-ui').style.display = 'flex';
            mobilePause.style.display = 'flex'; muteBtn.style.display = 'none';
            if (state !== 'paused') {
                score = 0; rauMa = 0; mode = 'cube'; speed = 10;
                obs = []; items = []; ports = []; trails = [];
                p.y = c.height / 2; p.dy = 0;
                bgm.src = "music/" + songFiles[Math.floor(Math.random()*5)];
                bgm.loop = true; bgm.play().catch(()=>{});
            }
            state = 'playing'; bgm.volume = 1; anim();
        }

        function die() {
            state = 'dead'; mobilePause.style.display = 'none'; overlay.style.display = 'flex';
            muteBtn.style.display = 'none'; document.getElementById('title').innerText = "B·∫†N ƒê√É CH·∫æT";
            saveScore(score); bgm.pause();
        }

        // INPUTS
        window.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='ArrowUp'){if(state==='playing')isPress=true;}});
        window.addEventListener('keyup', e => { if(e.code==='Space'||e.code==='ArrowUp')isPress=false; });
        window.addEventListener('touchstart', e => { if(e.target.id==='mobile-pause'||e.target.className.includes('btn'))return; e.preventDefault(); if(state==='playing')isPress=true; }, {passive:false});
        window.addEventListener('touchend', () => isPress = false);
        window.addEventListener('mousedown', e => { if(e.button===0 && e.target.id!=='mobile-pause' && !e.target.className.includes('btn')) isPress=true; });
        window.addEventListener('mouseup', () => isPress = false);

        function checkGamepad() {
            const gps = navigator.getGamepads();
            if (gps[0]) {
                const x = gps[0].buttons[0].pressed, tri = gps[0].buttons[3].pressed;
                if (x) isPress=true; else if(lastX) isPress = false;
                if (tri && !lastTri) togglePause();
                lastX = x; lastTri = tri;
            }
        }

        function spawn() {
            if (state !== 'playing') return;
            const floor = c.height - 100;
            frame++;
            if (frame % 80 === 0 && mode === 'cube') obs.push({x: c.width, y: floor-44, w: 30, h: 42, t: 'bot'});
            if (frame % 450 === 0) {
                const modes = ['cube', 'ship', 'wave'].filter(m => m !== mode);
                ports.push({x: c.width, y: 50, w: 70, h: floor-50, to: modes[Math.floor(Math.random()*modes.length)]});
            }
            if (frame % 60 === 0) items.push({x: c.width, y: mode==='cube'?floor-80:150+Math.random()*(c.height-300)});
            
            if ((mode === 'ship' || mode === 'wave') && frame % 22 === 0) {
                let gap = mode === 'wave' ? 150 : 190;
                let mv = Math.sin(frame/18)*(c.height/4);
                obs.push({x: c.width, y: 50, w: 60, h: (c.height/2-gap)+mv, t: 'top'});
                obs.push({x: c.width, y: floor - ((c.height/2-gap)-mv), w: 60, h: (c.height/2-gap)-mv, t: 'bot'});
            }
        }

        function anim() {
            if (state !== 'playing') return;
            checkGamepad(); spawn(); score++;
            const floor = c.height - 100, ceil = 50;
            ctx.fillStyle = `hsla(${(frame/5)%360}, 20%, 5%, 1)`; ctx.fillRect(0,0,c.width,c.height);

            if (mode === 'ship') { p.dy += (isPress ? -0.85 : 0.75); p.dy *= 0.98; p.rot = p.dy*3; }
            else if (mode === 'wave') { p.dy = isPress ? -10.5 : 10.5; p.rot = isPress ? -45 : 45; }
            else { p.dy += 1.45; if(isPress && p.gnd) p.dy = -16.5; p.rot = p.gnd ? Math.round(p.rot/90)*90 : p.rot+8; }

            p.y += p.dy;
            if(p.y > floor-p.h){ p.y = floor-p.h; p.dy = 0; p.gnd = true; }
            else if(p.y < ceil){ p.y = ceil; p.dy = 0; } else p.gnd = false;

            // TRAIL
            if(mode!=='cube') {
                trails.push({x: p.x + p.w/2, y: p.y + p.h/2});
                if(trails.length > 25) trails.shift();
                ctx.beginPath(); ctx.strokeStyle = mode==='wave'?'#0ff':'#ff0'; ctx.lineWidth = 3;
                for(let i=0; i<trails.length; i++){
                    trails[i].x -= speed;
                    if(i===0) ctx.moveTo(trails[i].x, trails[i].y); else ctx.lineTo(trails[i].x, trails[i].y);
                }
                ctx.stroke();
            }

            ctx.fillStyle = `hsl(${(frame/5)%360}, 100%, 50%)`;
            ctx.fillRect(0, floor, c.width, 10); ctx.fillRect(0, ceil-10, c.width, 10);

            // FIX HITBOX: Th√™m padding l√πi v√†o trong
            const hitPad = 7; 
            obs.forEach((o, i) => { 
                o.x -= speed; ctx.fillStyle='#f44'; ctx.beginPath();
                if(o.t==='top'){ctx.moveTo(o.x,50);ctx.lineTo(o.x+o.w,50);ctx.lineTo(o.x+o.w/2,50+o.h);}
                else{ctx.moveTo(o.x,floor);ctx.lineTo(o.x+o.w,floor);ctx.lineTo(o.x+o.w/2,floor-o.h);}
                ctx.fill();
                
                // Logic va ch·∫°m ch√≠nh x√°c h∆°n
                if(p.x+hitPad < o.x+o.w && p.x+p.w-hitPad > o.x && p.y+hitPad < (o.t==='top'?50+o.h:floor) && p.y+p.h-hitPad > (o.t==='top'?50:floor-o.h)) die();
                if(o.x < -100) obs.splice(i, 1);
            });

            ports.forEach((o, i) => { 
                o.x -= speed; 
                // SHIP PORTAL = PINK (M√ÄU H·ªíNG)
                ctx.fillStyle = o.to==='ship' ? '#ff69b4' : (o.to==='wave' ? '#0ff' : '#0f0');
                ctx.globalAlpha=0.3; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.globalAlpha=1;
                if(p.x+p.w > o.x && p.x < o.x+o.w) { if(mode !== o.to) { mode = o.to; obs = []; trails = []; } }
                if(o.x < -100) ports.splice(i, 1);
            });

            items.forEach((m, i) => { 
                m.x -= speed; 
                if(hasImg) ctx.drawImage(raumaImg, m.x-22, m.y-22, 44, 44);
                else { ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(m.x,m.y,12,0,7); ctx.fill(); }
                if(Math.hypot(p.x+17-m.x, p.y+17-m.y) < 32){ items.splice(i,1); rauMa++; }
                if(m.x < -100) items.splice(i, 1);
            });

            ctx.save(); ctx.translate(p.x+p.w/2, p.y+p.h/2); ctx.rotate(p.rot*Math.PI/180);
            let pC = mode==='ship'?'#ff0':mode==='wave'?'#0ff':'#0f0';
            ctx.fillStyle=pC; ctx.shadowBlur=15; ctx.shadowColor=pC;
            ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.strokeRect(-p.w/2,-p.h/2,p.w,p.h);
            ctx.restore();

            document.getElementById('ui-rm').innerText = `Rau M√°: ${rauMa}`;
            document.getElementById('ui-sc').innerText = `${Math.floor(score/10)}m`;
            requestAnimationFrame(anim);
        }
        updateLeaderboardUI();
    </script>
</body>
</html>
