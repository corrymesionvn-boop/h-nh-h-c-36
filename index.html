<!DOCTYPE html>
<html>
<head>
    <title>Hình Học 36</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.85); color: white; z-index: 100; text-align: center;
        }
        #mobile-pause {
            position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px;
            background: rgba(255,255,255,0.2); border: 3px solid #fff; border-radius: 50%;
            color: white; font-size: 30px; display: none; align-items: center; justify-content: center;
            z-index: 200; font-weight: bold; pointer-events: auto;
        }
        .btn {
            padding: 15px 40px; font-size: 22px; cursor: pointer; border: none;
            border-radius: 50px; background: #2ecc71; color: white; font-weight: bold; margin: 10px;
        }
        #mute-btn { background: #e67e22; font-size: 16px; display: none; }
        #game-ui {
            position: fixed; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between;
            color: white; font-size: 24px; font-weight: bold; z-index: 50; pointer-events: none;
            text-shadow: 2px 2px #000;
        }
        .joke-warn { font-size: 14px; color: #f1c40f; margin-bottom: 20px; max-width: 80%; line-height: 1.4; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="game-ui" style="display:none">
        <div id="ui-rm">Rau Má: 0</div>
        <div id="ui-sc">0m</div>
    </div>

    <div id="mobile-pause">||</div>

    <div id="overlay">
        <h1 id="title" style="color: #2ecc71; font-size: 45px; margin-bottom: 5px;">HÌNH HỌC 36</h1>
        <div class="joke-warn">Lưu ý: Đây chỉ là game do AI làm ra với mục đích joke, vui được bao nhiêu thì cứ chơi nhé :D!</div>
        <div id="hi-display" style="margin-bottom: 20px; color: #f1c40f; font-size: 20px;">0m | 0 Rau Má</div>
        <button class="btn" onclick="startGame()">BẮT ĐẦU CHƠI</button>
        <button id="mute-btn" class="btn" onclick="toggleMute()">NHẠC: BẬT</button>
    </div>

    <canvas id="g"></canvas>

    <script>
        const c = document.getElementById('g'), ctx = c.getContext('2d');
        const overlay = document.getElementById('overlay'), mobilePause = document.getElementById('mobile-pause'), muteBtn = document.getElementById('mute-btn');
        const bgm = new Audio();
        const songFiles = ["music1.mp3", "music2.mp3", "music3.mp3", "music4.mp3", "music5.mp3"];
        
        const raumaImg = new Image();
        raumaImg.src = 'rauma.png';
        let hasImg = false; raumaImg.onload = () => hasImg = true;

        let state = 'start', score = 0, rauMa = 0, speed = 9, mode = 'cube', frame = 0, isMuted = false;
        let hiScore = localStorage.getItem('gdHiScore') || 0;
        let hiRauMa = localStorage.getItem('gdHiRauMa') || 0;
        const p = { x: 180, y: 0, w: 38, h: 38, dy: 0, rot: 0, gnd: false };
        let obs = [], items = [], ports = [];
        let isPress = false, lastX = false, lastTri = false;

        const resize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize = resize; resize();

        function toggleMute() {
            isMuted = !isMuted; bgm.muted = isMuted;
            muteBtn.innerText = isMuted ? "NHẠC: TẮT" : "NHẠC: BẬT";
        }

        function togglePause(e) {
            if(e) { e.stopPropagation(); e.preventDefault(); }
            if (state === 'playing') {
                state = 'paused'; overlay.style.display = 'flex'; mobilePause.style.display = 'none';
                muteBtn.style.display = 'inline-block'; document.getElementById('title').innerText = "TẠM DỪNG";
                bgm.volume = 0.2;
            } else if (state === 'paused') startGame();
        }

        mobilePause.addEventListener('touchstart', togglePause);
        mobilePause.addEventListener('mousedown', togglePause);

        function startGame() {
            overlay.style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            mobilePause.style.display = 'flex';
            muteBtn.style.display = 'none';
            if (state !== 'paused') {
                score = 0; rauMa = 0; mode = 'cube'; speed = 9;
                obs = []; items = []; ports = [];
                p.y = c.height / 2; p.dy = 0;
                bgm.src = "music/" + songFiles[Math.floor(Math.random()*5)];
                bgm.loop = true; bgm.play().catch(()=>{});
            }
            state = 'playing'; bgm.volume = 1; anim();
        }

        function die() {
            state = 'dead'; mobilePause.style.display = 'none'; overlay.style.display = 'flex';
            muteBtn.style.display = 'none'; document.getElementById('title').innerText = "BẠN ĐÃ CHẾT";
            if (score > hiScore) { hiScore = score; localStorage.setItem('gdHiScore', hiScore); }
            if (rauMa > hiRauMa) { hiRauMa = rauMa; localStorage.setItem('gdHiRauMa', hiRauMa); }
            updateUI(); bgm.pause();
        }

        function updateUI() {
            document.getElementById('hi-display').innerText = `${Math.floor(hiScore/10)}m | ${hiRauMa} Rau Má`;
            document.getElementById('ui-rm').innerText = `Rau Má: ${rauMa}`;
            document.getElementById('ui-sc').innerText = `${Math.floor(score/10)}m`;
        }

        // --- HỆ THỐNG ĐIỀU KHIỂN ĐA NỀN TẢNG (FIXED) ---
        
        // 1. Máy tính (Phím Space/Up)
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                if (state === 'playing') isPress = true;
                else if (overlay.style.display === 'none') startGame();
            }
        });
        window.addEventListener('keyup', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') isPress = false;
        });

        // 2. Máy tính (Chuột)
        window.addEventListener('mousedown', (e) => {
            if (e.button === 0 && e.target.id !== 'mobile-pause' && !e.target.className.includes('btn')) {
                if (state === 'playing') isPress = true;
                else if (overlay.style.display === 'none') startGame();
            }
        });
        window.addEventListener('mouseup', () => isPress = false);

        // 3. Điện thoại (Touch)
        window.addEventListener('touchstart', (e) => {
            if (e.target.id === 'mobile-pause' || e.target.className.includes('btn')) return;
            e.preventDefault();
            if (state === 'playing') isPress = true;
            else if (overlay.style.display === 'none') startGame();
        }, { passive: false });
        window.addEventListener('touchend', () => isPress = false);

        // 4. Gamepad PS4
        function checkGamepad() {
            const gps = navigator.getGamepads();
            if (gps[0]) {
                const x = gps[0].buttons[0].pressed, tri = gps[0].buttons[3].pressed;
                if (x) { if(state==='playing') isPress=true; else if(!lastX) startGame(); } else if(!x && lastX) isPress = false;
                if (tri && !lastTri) togglePause();
                lastX = x; lastTri = tri;
            }
        }

        function spawn() {
            if (state !== 'playing') return;
            const floor = c.height - 100, isHard = score > 2000;
            if (frame % 85 === 0 && mode === 'cube') {
                let count = isHard ? (Math.random() > 0.5 ? 3 : 2) : 1;
                for(let i=0; i<count; i++) obs.push({x: c.width + (i*35), y: floor-44, w: 32, h: 44, t: 'bot'});
            }
            if (frame % 450 === 0) {
                const list = ['cube', 'ship', 'wave'].filter(m => m !== mode);
                ports.push({x: c.width, y: 50, w: 70, h: floor-50, to: list[Math.floor(Math.random()*list.length)]});
            }
            if (frame % 60 === 0) items.push({x: c.width, y: mode==='cube'?floor-75:150+Math.random()*(c.height-300)});
        }

        function anim() {
            if (state !== 'playing') return;
            checkGamepad(); frame++; score++;
            const floor = c.height - 100, ceil = 50;
            ctx.fillStyle = `hsla(${(frame/5)%360}, 30%, 5%, 1)`; ctx.fillRect(0,0,c.width,c.height);

            if (mode === 'ship') { p.dy += (isPress ? -0.85 : 0.75); p.dy *= 0.98; p.rot = p.dy*2.5; }
            else if (mode === 'wave') { p.dy = isPress ? -10 : 10; p.rot = isPress ? -45 : 45; }
            else { p.dy += 1.45; if(isPress && p.gnd) p.dy = -16.5; p.rot = p.gnd ? Math.round(p.rot/90)*90 : p.rot+7; }

            p.y += p.dy;
            if(p.y > floor-p.h){ p.y = floor-p.h; p.dy = 0; p.gnd = true; }
            else if(p.y < ceil){ p.y = ceil; p.dy = 0; } else p.gnd = false;

            ctx.fillStyle = `hsl(${(frame/5)%360}, 100%, 50%)`;
            ctx.fillRect(0, floor, c.width, 10); ctx.fillRect(0, ceil-10, c.width, 10);

            obs.forEach((o, i) => { 
                o.x -= speed; ctx.fillStyle='#f44'; ctx.beginPath();
                if(o.t==='top'){ctx.moveTo(o.x,50);ctx.lineTo(o.x+o.w,50);ctx.lineTo(o.x+o.w/2,50+o.h);}
                else{ctx.moveTo(o.x,floor);ctx.lineTo(o.x+o.w,floor);ctx.lineTo(o.x+o.w/2,floor-o.h);}
                ctx.fill();
                if(p.x+8 < o.x+o.w && p.x+p.w-8 > o.x && p.y+8 < o.y+o.h && p.y+p.h-8 > o.y) die();
                if(o.x < -100) obs.splice(i, 1);
            });

            ports.forEach((o, i) => { 
                o.x -= speed; ctx.fillStyle=o.to==='wave'?'#0ff':o.to==='ship'?'#ff0':'#0f0';
                ctx.globalAlpha=0.3; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.globalAlpha=1;
                if(p.x+p.w > o.x && p.x < o.x+o.w) { if(mode !== o.to) { mode = o.to; obs = []; } }
                if(o.x < -100) ports.splice(i, 1);
            });

            items.forEach((m, i) => { 
                m.x -= speed; 
                if(hasImg) ctx.drawImage(raumaImg, m.x-22, m.y-22, 44, 44);
                else { ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(m.x,m.y,12,0,7); ctx.fill(); }
                if(Math.hypot(p.x+19-m.x, p.y+19-m.y) < 36){ items.splice(i,1); rauMa++; }
                if(m.x < -100) items.splice(i, 1);
            });

            ctx.save(); ctx.translate(p.x+p.w/2, p.y+p.h/2); ctx.rotate(p.rot*Math.PI/180);
            let pC = mode==='ship'?'#ff0':mode==='wave'?'#0ff':'#0f0';
            ctx.fillStyle=pC; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();

            updateUI(); requestAnimationFrame(anim);
        }
        setInterval(spawn, 50);
        updateUI();
    </script>
</body>
</html>
