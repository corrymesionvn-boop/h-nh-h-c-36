<!DOCTYPE html>
<html>
<head>
    <title>H√¨nh H·ªçc 36 - Final Mystery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        /* GI·ªÆ NGUY√äN STYLE G·ªêC */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; -webkit-user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #game-ui { position: fixed; top: 20px; left: 20px; color: white; font-size: 18px; font-weight: bold; pointer-events: none; z-index: 100; text-shadow: 2px 2px #000; }
        .top-btns { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1001; }
        .ctrl-btn { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border: 2px solid #fff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 20px; }
        
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); color: white; z-index: 2000; text-align: center; }
        .skill-container { position: fixed; bottom: 30px; display: flex; flex-direction: column; align-items: center; z-index: 1000; }
        .use-btn { width: 65px; height: 65px; border-radius: 50%; border: 3px solid #fff; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 11px; margin-bottom: 5px; }
        .timer-bar { width: 55px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .timer-fill { height: 100%; width: 0%; background: #fff; }
        .rank-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin: 10px; min-width: 250px; border: 1px dashed #444; }
        .rank-item { display: flex; justify-content: space-between; color: #f1c40f; margin: 4px 0; font-size: 16px; }
        button.main-btn { padding: 15px 40px; background: #2ecc71; color: white; border-radius: 40px; font-size: 20px; border: none; cursor: pointer; margin: 10px; font-weight: bold; box-shadow: 0 4px #27ae60; }
        .shop-item { background: #e67e22; color: white; padding: 8px 15px; border-radius: 5px; border: none; margin: 5px; font-weight: bold; cursor: pointer; }
        #ee-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; }
        #ee-video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <div id="game-ui">
        <div id="ui-rm" style="display: none;">Rau M√°: 0</div> <div id="ui-sc">0m</div>
    </div>
    <div class="top-btns">
        <div class="ctrl-btn" id="mute-btn" onclick="toggleMute()">üîä</div>
        <div class="ctrl-btn" onclick="togglePause()">II</div>
    </div>

    <div id="cont-shield" class="skill-container" style="left: 20px;"><div class="use-btn" id="label-shield" style="background:#3498db" onclick="activateItem('shield')">üõ°Ô∏è x0</div><div class="timer-bar"><div id="timer-shield" class="timer-fill" style="background:#3498db"></div></div></div>
    <div id="cont-speed" class="skill-container" style="left: 100px;"><div class="use-btn" id="label-speed" style="background:#9b59b6" onclick="activateItem('speed')">‚ö° x0</div><div class="timer-bar"><div id="timer-speed" class="timer-fill" style="background:#9b59b6"></div></div></div>

    <div id="overlay">
        <div style="color:#ff4444; font-weight:bold; margin-bottom:5px; text-transform: uppercase;">‚ö†Ô∏è C·∫¢NH B√ÅO: Game n√†y do AI l√†m ra v·ªõi m·ª•c ƒë√≠ch joke, kh√¥ng c√≥ √Ω x√∫c ph·∫°m t·ªõi t·ªï ch·ª©c hay c√° nh√¢n n√†o c·∫£ ‚ö†Ô∏è</div>
        <h2 style="color:#f1c40f; margin:0; font-size: 18px;">Update 1.2:</h2>
        <div style="font-size: 14px; color: #ccc; margin-bottom: 10px; line-height: 1.6;">
            - Th√™m Boss<br>
            - Th√™m Easter Egg
        </div>
        <h1 id="title" style="color:#2ecc71; margin: 5px 0; font-size: 36px; text-shadow: 0 0 10px rgba(46,204,113,0.5);">H√åNH H·ªåC 36</h1>
        <div id="wallet" style="color:#f1c40f; font-size:22px; font-weight:bold; margin-bottom: 10px;">0 Rau M√°</div>
        <div class="rank-box">
            <div id="top1" class="rank-item"><span>üèÜ TOP 1:</span> 0m</div>
            <div id="top2" class="rank-item"><span>ü•à TOP 2:</span> 0m</div>
            <div id="top3" class="rank-item"><span>ü•â TOP 3:</span> 0m</div>
        </div>
        <div>
            <button class="shop-item" onclick="buyItem('shield', 20)">Khi√™n (20)</button>
            <button class="shop-item" onclick="buyItem('speed', 10)">T·ªëc ƒë·ªô (10)</button>
        </div>
        <button class="main-btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="ee-container"><video id="ee-video" src="video.mp4" playsinline></video></div>
    <canvas id="g"></canvas>

    <script>
        const c = document.getElementById('g'), ctx = c.getContext('2d');
        const raumaImg = new Image(); raumaImg.src = 'rauma.png';
        const bossImg = new Image(); bossImg.src = 'boss.png';
        const weaponImg = new Image(); weaponImg.src = 'weapon.png';
        const bgm = new Audio();
        const eeVideo = document.getElementById('ee-video');
        const eeCont = document.getElementById('ee-container');

        const playlist = ["BackOnTrack.mp3", "BaseAfterBase.mp3", "BlastProcessing.mp3", "CantLetGo.mp3", "Clubstep.mp3", "Clutterfunk.mp3", "Cycles.mp3", "Dash.mp3", "Deadlocked.mp3", "DJRubRub.mp3", "DryOut.mp3", "Electrodynamix.mp3", "Electroman.mp3", "Fingerdash.mp3", "GeometricalDominator.mp3", "HexagonForce.mp3", "Jumper.mp3", "Polargeist.mp3", "PowerTrip.mp3", "StayInsideMe.mp3", "StereoMadness.mp3", "TheoryOfEverything.mp3", "TheoryOfEverything2.mp3", "TimeMachine.mp3", "xStep.mp3"];

        let totalRauMa = parseInt(localStorage.getItem('totalRauMa')) || 0;
        let inventory = JSON.parse(localStorage.getItem('gdInventory')) || { shield: 0, speed: 0 };
        let highscores = JSON.parse(localStorage.getItem('gdTopScores')) || [0,0,0];

        let state = 'start', score = 0, currentRauMa = 0, mode = 'cube', frame = 0, isPress = false, isMuted = false;
        let p = { x: 180, y: 0, w: 30, h: 30, dy: 0, rot: 0, gnd: false, grav: 1, ufoClick: false, iframes: 0 };
        let obs = [], blocks = [], items = [], portals = [], activeBuffs = { shield: 0, speed: 0 };
        let bgColor = { h: 200, s: 50, l: 20 };
        let boss = { active: false, appeared: false, y: 200, hp: 300, maxHp: 300, bullets: [], weapons: [], pProjectiles: [] };

        const floorY = () => c.height - 100;
        const ceilY = () => 50;

        function playEasterEgg() {
            state = 'easteregg';
            bgm.pause();
            eeCont.style.display = 'block';
            eeVideo.play();
            eeVideo.onended = () => { location.reload(); };
        }

        function updateUI() {
            document.getElementById('wallet').innerText = `${totalRauMa} Rau M√°`;
            document.getElementById('top1').innerHTML = `<span>üèÜ TOP 1:</span> ${highscores[0]}m`;
            document.getElementById('top2').innerHTML = `<span>ü•à TOP 2:</span> ${highscores[1]}m`;
            document.getElementById('top3').innerHTML = `<span>ü•â TOP 3:</span> ${highscores[2]}m`;
            document.getElementById('ui-sc').innerText = `${Math.floor(score/10)}m`;
            document.getElementById('label-shield').innerText = `üõ°Ô∏è x${inventory.shield}`;
            document.getElementById('label-speed').innerText = `‚ö° x${inventory.speed}`;
            document.getElementById('timer-shield').style.width = (activeBuffs.shield/600*100) + "%";
            document.getElementById('timer-speed').style.width = (activeBuffs.speed/600*100) + "%";
        }

        function die() {
            if(p.iframes > 0) return;
            if(activeBuffs.shield > 0) { activeBuffs.shield = 0; p.iframes = 60; p.dy = -8; return; }
            state = 'dead'; totalRauMa += currentRauMa;
            highscores.push(Math.floor(score/10)); highscores.sort((a,b)=>b-a).splice(3);
            localStorage.setItem('gdTopScores', JSON.stringify(highscores));
            localStorage.setItem('totalRauMa', totalRauMa);
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('title').innerText = "B·∫†N ƒê√É CH·∫æT";
            bgm.pause(); updateUI();
        }

        function toggleMute() { isMuted = !isMuted; bgm.muted = isMuted; document.getElementById('mute-btn').innerText = isMuted ? "üîà" : "üîä"; }
        function buyItem(t, cost) { if(totalRauMa >= cost){ totalRauMa -= cost; inventory[t]++; updateUI(); localStorage.setItem('gdInventory', JSON.stringify(inventory)); localStorage.setItem('totalRauMa', totalRauMa); } }
        function activateItem(t) { if(state==='playing' && inventory[t]>0 && activeBuffs[t]<=0){ inventory[t]--; activeBuffs[t]=600; updateUI(); } }
        function togglePause() { if(state==='playing'){ state='paused'; bgm.pause(); document.getElementById('overlay').style.display='flex'; document.getElementById('title').innerText="T·∫†M D·ª™NG"; } }

        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            if(state !== 'paused') {
                score = 0; currentRauMa = 0; mode = 'cube'; obs = []; blocks = []; items = []; portals = [];
                p.y = floorY()-35; p.dy = 0; p.grav = 1; p.iframes = 0;
                boss = { active: false, appeared: false, y: 200, hp: 300, maxHp: 300, bullets: [], weapons: [], pProjectiles: [] };
                bgm.src = "music/" + playlist[Math.floor(Math.random() * playlist.length)];
                bgm.loop = true; bgm.play().catch(()=>{});
            } else { bgm.play(); }
            state = 'playing'; updateUI(); anim();
        }

        window.onmousedown = () => { isPress = true; p.ufoClick = true; };
        window.onmouseup = () => { isPress = false; p.ufoClick = false; };
        window.ontouchstart = (e) => { if(!e.target.closest('.skill-container') && !e.target.closest('.ctrl-btn')) { isPress = true; p.ufoClick = true; e.preventDefault(); } };
        window.ontouchend = () => { isPress = false; p.ufoClick = false; };
        window.onkeydown = (e) => { if(e.code==='Space'||e.code==='ArrowUp') { isPress = true; p.ufoClick = true; } };
        window.onkeyup = (e) => { if(e.code==='Space'||e.code==='ArrowUp') { isPress = false; p.ufoClick = false; } };

        function anim() {
            if(state !== 'playing') return;
            frame++; score++;
            
            bgColor.h = (bgColor.h + 0.2) % 360;
            ctx.fillStyle = boss.active ? '#1a0000' : `hsl(${bgColor.h}, 40%, 15%)`;
            ctx.fillRect(0, 0, c.width, c.height);

            ctx.fillStyle = `hsl(${bgColor.h}, 60%, 10%)`;
            ctx.fillRect(0, floorY(), c.width, 100); ctx.fillRect(0, 0, c.width, ceilY());
            ctx.strokeStyle = `hsl(${bgColor.h}, 80%, 50%)`; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(0, floorY()); ctx.lineTo(c.width, floorY()); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, ceilY()); ctx.lineTo(c.width, ceilY()); ctx.stroke();

            let difficulty = score > 2500 ? (1 + (score-2500)/12000) : 1;
            let curSpd = (9 + (activeBuffs.speed > 0 ? 4 : 0)) * difficulty;

            if(activeBuffs.shield > 0) activeBuffs.shield--;
            if(activeBuffs.speed > 0) activeBuffs.speed--;
            if(p.iframes > 0) p.iframes--;

            // Physics
            if(mode==='cube') { p.dy += 1.2; if(isPress && p.gnd) p.dy = -15; p.rot = p.gnd ? 0 : p.rot + 8; }
            else if(mode==='ship') { p.dy += (isPress ? -0.8 : 0.75); p.dy *= 0.98; p.rot = p.dy * 3; }
            else if(mode==='wave') { p.dy = isPress ? -10.5 : 10.5; p.rot = isPress ? -45 : 45; }
            else if(mode==='ufo') { p.dy += 0.6; if(p.ufoClick) { p.dy = -10; p.ufoClick = false; } p.rot += 2; }
            else if(mode==='ball') { if(p.ufoClick) { p.grav *= -1; p.ufoClick = false; } p.dy += 1.1 * p.grav; p.rot += 10 * p.grav; }
            else if(mode==='spider') { if(p.ufoClick) { p.y = (p.grav > 0) ? ceilY() : floorY()-p.h; p.grav *= -1; p.ufoClick = false; } p.dy = 0; }
            else if(mode==='robot') { p.dy += 1.2; if(isPress && p.gnd) p.dy = -16; p.rot = 0; }
            else if(mode==='swingcopter') { if(p.ufoClick) { p.grav *= -1; p.ufoClick = false; } p.dy += 0.6 * p.grav; p.rot = p.dy * 5; }

            p.y += p.dy; p.gnd = false;
            if(p.y > floorY()-p.h) { p.y = floorY()-p.h; p.dy = 0; p.gnd = true; }
            if(p.y < ceilY()) { p.y = ceilY(); p.dy = 0; if(mode==='wave'||mode==='ship') die(); }

            // Boss system - GAI ƒê·ªé
            if(Math.floor(score/10) >= 450 && !boss.appeared) { boss.active = true; boss.appeared = true; mode = 'ship'; }
            if(boss.active) {
                boss.y += (p.y - boss.y) * 0.05;
                if(bossImg.complete) ctx.drawImage(bossImg, c.width - 150, boss.y - 50, 100, 100);
                ctx.fillStyle = '#555'; ctx.fillRect(c.width - 150, boss.y - 70, 100, 10);
                ctx.fillStyle = '#f00'; ctx.fillRect(c.width - 150, boss.y - 70, (boss.hp/boss.maxHp)*100, 10);
                
                if(frame % 60 === 0) boss.bullets.push({x: c.width - 150, y: boss.y});
                boss.bullets.forEach((b, i) => {
                    b.x -= 12; ctx.fillStyle = '#ff0000';
                    ctx.beginPath(); ctx.arc(b.x, b.y, 9, 0, 7); ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.stroke();
                    if(Math.hypot(p.x-b.x, p.y-b.y) < 25) { boss.bullets.splice(i,1); die(); }
                });
                if(frame % 120 === 0) boss.weapons.push({x: c.width, y: 150 + Math.random()*(c.height-300)});
                boss.weapons.forEach((w, i) => {
                    w.x -= curSpd; if(weaponImg.complete) ctx.drawImage(weaponImg, w.x-20, w.y-20, 40, 40);
                    if(Math.hypot(p.x-w.x, p.y-w.y) < 30) { boss.weapons.splice(i,1); boss.pProjectiles.push({x: p.x, y: p.y}); }
                });
                boss.pProjectiles.forEach((pp, i) => {
                    pp.x += 20; if(weaponImg.complete) ctx.drawImage(weaponImg, pp.x-15, pp.y-15, 30, 30);
                    if(pp.x > c.width - 150 && Math.abs(pp.y - boss.y) < 50) {
                        boss.pProjectiles.splice(i, 1); boss.hp -= 25;
                        if(boss.hp <= 0) { boss.active = false; currentRauMa += 10; updateUI(); }
                    }
                });
            }

            // Sinh v·∫≠t c·∫£n
            if(!boss.active) {
                if(frame % 85 === 0) {
                    if (mode === 'spider' || mode === 'ball') {
                        let type = Math.random() > 0.5 ? 'top' : 'bot';
                        obs.push({x: c.width, y: type === 'top' ? ceilY() : floorY(), w: 30, h: 40, t: type});
                    } else {
                        obs.push({x: c.width, y: floorY()-35, w: 30, h: 35, t: 'bot'});
                        if(Math.random() > 0.6) blocks.push({x: c.width+250, y: floorY()-80, w: 40, h: 40});
                    }
                } else if(frame % 30 === 0 && (mode==='ship' || mode==='wave' || mode==='ufo' || mode==='swingcopter')) {
                    let waveY = Math.sin(frame/20)*(c.height/4);
                    let gap = 160 / difficulty;
                    obs.push({x: c.width, y: ceilY(), w: 45, h: (c.height/2-gap)+waveY, t: 'top'});
                    obs.push({x: c.width, y: floorY()-((c.height/2-gap)-waveY), w: 45, h: (c.height/2-gap)-waveY, t: 'bot'});
                }
            }

            obs.forEach((o, i) => {
                o.x -= curSpd; ctx.fillStyle = '#f33'; ctx.beginPath();
                if(o.t==='top') { ctx.moveTo(o.x, ceilY()); ctx.lineTo(o.x+o.w, ceilY()); ctx.lineTo(o.x+o.w/2, ceilY()+o.h); }
                else { ctx.moveTo(o.x, floorY()); ctx.lineTo(o.x+o.w, floorY()); ctx.lineTo(o.x+o.w/2, floorY()-o.h); }
                ctx.fill();
                if(p.x < o.x+o.w-5 && p.x+p.w > o.x+5) {
                    if(o.t==='top' && p.y < ceilY()+o.h-5) die();
                    if(o.t==='bot' && p.y+p.h > floorY()-o.h+5) die();
                }
                if(o.x < -100) obs.splice(i,1);
            });

            blocks.forEach((b, i) => {
                b.x -= curSpd; ctx.fillStyle = '#444'; ctx.fillRect(b.x, b.y, b.w, b.h); ctx.strokeStyle = '#fff'; ctx.strokeRect(b.x, b.y, b.w, b.h);
                if(p.x+p.w > b.x+5 && p.x < b.x+b.w-5 && p.y+p.h > b.y && p.y < b.y+b.h) {
                    if(p.dy > 0 && p.y+p.h < b.y+15) { p.y = b.y-p.h; p.dy = 0; p.gnd = true; } else die();
                }
                if(b.x < -100) blocks.splice(i,1);
            });

            // Portals & Items
            if(!boss.active && frame % 450 === 0) {
                const ms = ['cube','ship','wave','ufo','ball','spider','robot','swingcopter'];
                portals.push({x: c.width, to: ms[Math.floor(Math.random()*ms.length)]});
            }
            portals.forEach((prt, i) => {
                prt.x -= curSpd; ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(prt.x, 0, 50, c.height);
                if(p.x+p.w > prt.x && p.x < prt.x+50) { if(mode!==prt.to) { mode = prt.to; obs=[]; blocks=[]; p.grav=1; } }
                if(prt.x < -100) portals.splice(i,1);
            });

            if(frame % 60 === 0) items.push({x: c.width, y: mode==='cube'?floorY()-80:150+Math.random()*(c.height-300)});
            items.forEach((m, i) => {
                m.x -= curSpd; if(raumaImg.complete) ctx.drawImage(raumaImg, m.x-20, m.y-20, 40, 40);
                if(Math.hypot(p.x+15-m.x, p.y+15-m.y) < 32) { 
                    items.splice(i,1); 
                    currentRauMa++; 
                    updateUI();
                    if(currentRauMa >= 36) playEasterEgg();
                }
                if(m.x < -100) items.splice(i, 1);
            });

            // Player Render
            ctx.save(); ctx.translate(p.x+15, p.y+15); ctx.rotate(p.rot*Math.PI/180);
            ctx.globalAlpha = p.iframes > 0 ? 0.4 : 1;
            ctx.fillStyle = mode==='spider'?'#9b59b6':mode==='robot'?'#e74c3c':'#2ecc71';
            ctx.fillRect(-15, -15, 30, 30); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeRect(-15, -15, 30, 30);
            if(activeBuffs.shield > 0) { ctx.beginPath(); ctx.arc(0,0,22,0,7); ctx.strokeStyle='#3498db'; ctx.stroke(); }
            ctx.restore();

            updateUI(); requestAnimationFrame(anim);
        }
        window.onresize = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
        window.onresize(); updateUI();
    </script>
</body>
</html>
